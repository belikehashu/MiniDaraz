{% extends "base.html" %}
{% block title %}Product Details{% endblock %}

{% block content %}
<a href="{% url 'index' %}" style="text-decoration: none; color: #3498db;">← Back to All Products</a>

<div style="margin-top: 30px; display: flex; gap: 40px; flex-wrap: wrap; background: white; padding: 25px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); align-items: flex-end;">
  <div style="flex: 1; min-width: 300px;">
    <img src="{{ product.image.url }}" alt="{{ product.name }}"
         style="width: 100%; max-width: 350px; height: auto; object-fit: contain; border: 1px solid #ccc; border-radius: 6px;">
    
    {% if product.images.all %}
    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
      {% for img in product.images.all %}
        <img src="{{ img.image.url }}" alt=""
             style="width: 80px; height: 80px; object-fit: cover; border: 1px solid #ccc; border-radius: 4px;">
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <div style="flex: 2; min-width: 300px; display: flex; flex-direction: column; justify-content: flex-end;">
    <div>
      <h2 style="font-size: 26px; color: #2c3e50;">{{ product.name }}</h2>
      <p style="font-weight: bold; font-size: 18px; margin-top: 10px;">Price: Rs. {{ product.price }}</p>
      <p style="font-size: 16px; color: #27ae60; margin-top: 5px;">
        {% if product.stock > 0 %}
          In Stock: {{ product.stock }}
        {% else %}
          <span style="color: red;">Out of Stock</span>
        {% endif %}
      </p>
    </div>

    <div style="margin-top: 20px; display: flex; gap: 15px;">
      <a href="{% url 'buy_now' product.id %}" style="flex: 1;">
        <button style="width: 100%; padding: 10px; background-color: #2ecc71; color: white; border: none; border-radius: 4px; font-size: 14px;"
                {% if product.stock <= 0 %} disabled style="opacity: 0.5; cursor: not-allowed;" {% endif %}>
          Buy Now
        </button>
      </a>
      <a href="{% url 'add_to_cart' product.id %}" style="flex: 1;">
        <button style="width: 100%; padding: 10px; background-color: #f39c12; color: white; border: none; border-radius: 4px; font-size: 14px;"
                {% if product.stock <= 0 %} disabled style="opacity: 0.5; cursor: not-allowed;" {% endif %}>
          Add to Cart
        </button>
      </a>
    </div>
  </div>
</div>

<div style="margin-top: 30px; background: #fff; padding: 25px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.04);">
  <h3 style="margin-top: 0; color: #2c3e50;">Product Description</h3>
  <p style="font-size: 15px; color: #444; line-height: 1.7;">{{ product.description }}</p>
</div>

<div style="margin-top: 40px; background: #f9f9f9; padding: 25px; border: 1px solid #ddd; border-radius: 8px;">
  <h3 style="margin-bottom: 20px; color: #2c3e50;">User Reviews</h3>

  {% for review in reviews %}
    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 6px; background: white;">
      <strong>{{ review.user.first_name }}</strong> rated:
      <span style="color: #f1c40f;">
        {% for i in "12345"|slice:":review.rating"|make_list %}
          &#9733;
        {% endfor %}
      </span>
      <p style="margin-top: 5px;">{{ review.comment }}</p>
      <small style="color: #888;">{{ review.created_at|date:"F j, Y, g:i a" }}</small>

      {% if user == review.user %}
        <div style="margin-top: 5px;">
          <a href="{% url 'edit_review' review.id %}">Edit</a> |
          <a href="{% url 'delete_review' review.id %}" onclick="return confirm('Are you sure you want to delete this review?');">Delete</a>
        </div>
      {% endif %}
    </div>
  {% empty %}
    <p>No reviews yet.</p>
  {% endfor %}

  {% if user.is_authenticated and has_purchased %}
    <form method="post" style="margin-top: 30px;">
      {% csrf_token %}
      <h4 style="margin-bottom: 15px;">Leave a Review</h4>
      
      <div style="background-color: #fff; padding: 20px; border-radius: 6px; border: 1px solid #ccc;">
        {% if form.non_field_errors %}
          <ul style="color: red; list-style: none; padding: 0;">
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {{ form.as_p }}
      </div>

      <button type="submit"
              style="margin-top: 15px; padding: 8px 16px; background: #2ecc71; color: white; border: none; border-radius: 6px;">
        Submit Review
      </button>
    </form>
  {% elif user.is_authenticated %}
    <p style="margin-top: 20px;">You can only review products you’ve received.</p>
  {% else %}
    <p style="margin-top: 20px;">Please <a href="{% url 'login' %}?next={{ request.path }}">login</a> to leave a review.</p>
  {% endif %}
</div>
{% endblock %}
